# æ•°æ®åº“é›†åˆè¯´æ˜

## é›†åˆåˆ—è¡¨

### 1. usersï¼ˆç”¨æˆ·è¡¨ï¼‰
å­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯

**å­—æ®µè¯´æ˜ï¼š**
- `_id`: ç”¨æˆ·IDï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
- `_openid`: ç”¨æˆ·OpenID
- `nickName`: æ˜µç§°
- `avatarUrl`: å¤´åƒURL
- `createTime`: åˆ›å»ºæ—¶é—´
- `updateTime`: æ›´æ–°æ—¶é—´

### 2. billsï¼ˆè´¦å•è¡¨ï¼‰
å­˜å‚¨æ‰€æœ‰è´¦å•è®°å½•

**å­—æ®µè¯´æ˜ï¼š**
- `_id`: è´¦å•IDï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
- `_openid`: ç”¨æˆ·OpenID
- `type`: ç±»å‹ï¼ˆincome/expenseï¼‰
- `amount`: é‡‘é¢
- `category`: åˆ†ç±»ä¿¡æ¯ï¼ˆå¯¹è±¡ï¼‰
  - `name`: åˆ†ç±»åç§°
  - `icon`: å›¾æ ‡
  - `color`: é¢œè‰²
- `account`: è´¦æˆ·ä¿¡æ¯ï¼ˆå¯¹è±¡ï¼‰
  - `name`: è´¦æˆ·åç§°
  - `icon`: å›¾æ ‡
- `date`: æ—¥æœŸ
- `remark`: å¤‡æ³¨
- `createTime`: åˆ›å»ºæ—¶é—´

**ç´¢å¼•å»ºè®®ï¼š**
- `_openid`: ç”¨æˆ·æŸ¥è¯¢
- `date`: æ—¥æœŸæŸ¥è¯¢
- `type`: ç±»å‹æŸ¥è¯¢

### 3. categoriesï¼ˆåˆ†ç±»è¡¨ï¼‰
å­˜å‚¨æ¶ˆè´¹å’Œæ”¶å…¥åˆ†ç±»

**å­—æ®µè¯´æ˜ï¼š**
- `_id`: åˆ†ç±»IDï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
- `type`: ç±»å‹ï¼ˆincome/expenseï¼‰
- `name`: åˆ†ç±»åç§°
- `icon`: å›¾æ ‡ï¼ˆemojiï¼‰
- `color`: é¢œè‰²ï¼ˆhexï¼‰
- `sort`: æ’åº
- `createTime`: åˆ›å»ºæ—¶é—´

### 4. accountsï¼ˆè´¦æˆ·è¡¨ï¼‰
å­˜å‚¨è´¦æˆ·ä¿¡æ¯

**å­—æ®µè¯´æ˜ï¼š**
- `_id`: è´¦æˆ·IDï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
- `_openid`: ç”¨æˆ·OpenID
- `name`: è´¦æˆ·åç§°
- `icon`: å›¾æ ‡ï¼ˆemojiï¼‰
- `color`: é¢œè‰²ï¼ˆhexï¼‰
- `balance`: ä½™é¢
- `sort`: æ’åº
- `createTime`: åˆ›å»ºæ—¶é—´

### 5. budgetï¼ˆé¢„ç®—è¡¨ï¼‰
å­˜å‚¨æœˆåº¦é¢„ç®—è®¾ç½®

**å­—æ®µè¯´æ˜ï¼š**
- `_id`: é¢„ç®—IDï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
- `_openid`: ç”¨æˆ·OpenID
- `year`: å¹´ä»½
- `month`: æœˆä»½
- `amount`: é¢„ç®—é‡‘é¢
- `createTime`: åˆ›å»ºæ—¶é—´
- `updateTime`: æ›´æ–°æ—¶é—´

## åˆå§‹åŒ–æ•°æ®

é¦–æ¬¡ä½¿ç”¨æ—¶éœ€è¦è¿è¡Œ `initDB` äº‘å‡½æ•°æ¥åˆå§‹åŒ–åˆ†ç±»å’Œè´¦æˆ·æ•°æ®ã€‚

### æ–¹å¼ä¸€ï¼šåœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­è¿è¡Œï¼ˆæ¨èï¼‰

1. **åˆ›å»ºäº‘å¼€å‘ç¯å¢ƒ**
   - ç‚¹å‡»å¾®ä¿¡å¼€å‘è€…å·¥å…·é¡¶éƒ¨çš„ã€Œäº‘å¼€å‘ã€æŒ‰é’®
   - å¦‚æœè¿˜æ²¡åˆ›å»ºï¼Œä¼šæç¤ºä½ å¼€é€šäº‘å¼€å‘ï¼ˆå…è´¹ï¼‰
   - æŒ‰æç¤ºå®Œæˆåˆ›å»º

2. **ä¸Šä¼ äº‘å‡½æ•°**
   - åœ¨é¡¹ç›®å·¦ä¾§ç›®å½•ä¸­ï¼Œæ‰¾åˆ° `cloudfunctions` æ–‡ä»¶å¤¹
   - å³é”®ç‚¹å‡» `initDB` æ–‡ä»¶å¤¹
   - é€‰æ‹©ã€Œä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–ã€
   - ç­‰å¾…ä¸Šä¼ å®Œæˆï¼ˆæ˜¾ç¤º"ä¸Šä¼ æˆåŠŸ"ï¼‰

3. **è¿è¡Œäº‘å‡½æ•°**
   - å†æ¬¡å³é”®ç‚¹å‡» `initDB` æ–‡ä»¶å¤¹
   - é€‰æ‹©ã€Œäº‘ç«¯æµ‹è¯•ã€
   - åœ¨å¼¹å‡ºçš„æµ‹è¯•çª—å£ä¸­ï¼Œç›´æ¥ç‚¹å‡»ã€Œæµ‹è¯•ã€æŒ‰é’®ï¼ˆä¸éœ€è¦å¡«å†™ä»»ä½•å‚æ•°ï¼‰
   - æŸ¥çœ‹æµ‹è¯•ç»“æœï¼Œåº”è¯¥æ˜¾ç¤ºï¼š
     ```json
     {
       "success": true,
       "message": "æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ",
       "data": {
         "categories": {
           "added": 14,
           "skipped": 0,
           "total": 14
         },
         "accounts": {
           "added": 4,
           "skipped": 0,
           "total": 4
         }
       }
     }
     ```

### æ–¹å¼äºŒï¼šåœ¨ä»£ç ä¸­è°ƒç”¨

ä¹Ÿå¯ä»¥åœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨äº‘å‡½æ•°ï¼š

```javascript
wx.cloud.callFunction({
  name: 'initDB',
  success: res => {
    if (res.result.success) {
      console.log('åˆå§‹åŒ–æˆåŠŸ', res.result.message)
      console.log(`å·²æ·»åŠ  ${res.result.categoriesCount} ä¸ªåˆ†ç±»`)
      console.log(`å·²æ·»åŠ  ${res.result.accountsCount} ä¸ªè´¦æˆ·`)
    }
  },
  fail: err => {
    console.error('åˆå§‹åŒ–å¤±è´¥', err)
  }
})
```

### é¢„ç½®æ•°æ®

è¿è¡Œ `initDB` äº‘å‡½æ•°åï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä»¥ä¸‹æ•°æ®ï¼š

#### åˆ†ç±»æ•°æ®ï¼ˆ9ä¸ªæ”¯å‡ºåˆ†ç±» + 5ä¸ªæ”¶å…¥åˆ†ç±»ï¼‰
- æ”¯å‡ºï¼šé¤é¥® ğŸ”ã€äº¤é€š ğŸš—ã€è´­ç‰© ğŸ›’ã€å¨±ä¹ ğŸ®ã€åŒ»ç–— ğŸ’Šã€æ•™è‚² ğŸ“šã€å±…ä½ ğŸ ã€é€šè®¯ ğŸ“±ã€å…¶ä»– ğŸ“¦
- æ”¶å…¥ï¼šå·¥èµ„ ğŸ’°ã€å¥–é‡‘ ğŸã€æŠ•èµ„ ğŸ“ˆã€å…¼èŒ ğŸ’¼ã€å…¶ä»– ğŸ’µ

#### è´¦æˆ·æ•°æ®ï¼ˆ4ä¸ªé»˜è®¤è´¦æˆ·ï¼‰
- ç°é‡‘ ğŸ’µ
- å¾®ä¿¡ ğŸ’¬
- æ”¯ä»˜å® ğŸ”µ
- é“¶è¡Œå¡ ğŸ’³

### å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆè¦åˆå§‹åŒ–æ•°æ®åº“ï¼Ÿ**

A: åˆå§‹åŒ–æ•°æ®åº“ä¼šåˆ›å»ºé»˜è®¤çš„åˆ†ç±»å’Œè´¦æˆ·æ•°æ®ï¼Œè¿™æ ·æ‰èƒ½æ­£å¸¸ä½¿ç”¨è®°è´¦åŠŸèƒ½ã€‚å¦‚æœæ²¡æœ‰åˆå§‹åŒ–ï¼Œç‚¹å‡»ã€Œè´¦æˆ·ã€é€‰æ‹©æ—¶ä¼šæç¤º"æš‚æ— è´¦æˆ·"ã€‚

**Q: åˆå§‹åŒ–åå¯ä»¥ä¿®æ”¹åˆ†ç±»å’Œè´¦æˆ·å—ï¼Ÿ**

A: å¯ä»¥ï¼åˆå§‹åŒ–åªæ˜¯åˆ›å»ºé»˜è®¤æ•°æ®ï¼Œä½ å¯ä»¥åœ¨ã€Œæˆ‘çš„ã€é¡µé¢ä¸­ç®¡ç†è‡ªå·±çš„åˆ†ç±»å’Œè´¦æˆ·ã€‚

**Q: å¤šæ¬¡è¿è¡Œ initDB ä¼šé‡å¤æ·»åŠ æ•°æ®å—ï¼Ÿ**

A: ä¸ä¼šã€‚initDB ä¼šæ£€æŸ¥æ•°æ®æ˜¯å¦å·²å­˜åœ¨ï¼Œåªæœ‰åœ¨ä¸å­˜åœ¨æ—¶æ‰ä¼šæ·»åŠ ï¼Œæ‰€ä»¥å¯ä»¥å®‰å…¨åœ°å¤šæ¬¡è¿è¡Œã€‚

**Q: è¿è¡Œ initDB æ—¶æç¤º "collection not exists" æ€ä¹ˆåŠï¼Ÿ**

A: è¿™ä¸ªé”™è¯¯æ˜¯å› ä¸ºæ•°æ®åº“é›†åˆè¿˜æ²¡æœ‰åˆ›å»ºã€‚æ–°ç‰ˆæœ¬çš„ initDB äº‘å‡½æ•°ä¼šè‡ªåŠ¨åˆ›å»ºé›†åˆï¼Œä½ åªéœ€è¦ï¼š
1. é‡æ–°ä¸Šä¼  initDB äº‘å‡½æ•°ï¼ˆå³é”® â†’ ä¸Šä¼ å¹¶éƒ¨ç½²ï¼‰
2. å†æ¬¡è¿è¡Œäº‘ç«¯æµ‹è¯•

**Q: éœ€è¦æ‰‹åŠ¨åˆ›å»ºæ•°æ®åº“é›†åˆå—ï¼Ÿ**

A: ä¸éœ€è¦ï¼initDB äº‘å‡½æ•°ä¼šè‡ªåŠ¨åˆ›å»º `categories` å’Œ `accounts` ä¸¤ä¸ªé›†åˆã€‚å¦‚æœéœ€è¦åˆ›å»ºå…¶ä»–é›†åˆï¼ˆå¦‚ `bills`ã€`users`ï¼‰ï¼Œå¯ä»¥åœ¨äº‘å¼€å‘æ§åˆ¶å°æ‰‹åŠ¨åˆ›å»ºï¼Œæˆ–è€…åœ¨é¦–æ¬¡è®°è´¦æ—¶è‡ªåŠ¨åˆ›å»ºã€‚

## æ•°æ®æƒé™

æ‰€æœ‰é›†åˆéƒ½éœ€è¦è®¾ç½®æƒé™ä¸ºï¼š
- **è¯»æƒé™**: ä»…åˆ›å»ºè€…å¯è¯»
- **å†™æƒé™**: ä»…åˆ›å»ºè€…å¯å†™

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç´¢å¼•ä¼˜åŒ–**
   - ä¸º `bills` é›†åˆåˆ›å»ºå¤åˆç´¢å¼•ï¼š`_openid + date`
   - ä¸º `bills` é›†åˆåˆ›å»ºå¤åˆç´¢å¼•ï¼š`_openid + type`

2. **æ•°æ®åˆ†é¡µ**
   - è´¦å•åˆ—è¡¨æŸ¥è¯¢å»ºè®®ä½¿ç”¨ `skip()` å’Œ `limit()` è¿›è¡Œåˆ†é¡µ
   - å•æ¬¡æŸ¥è¯¢å»ºè®®ä¸è¶…è¿‡ 20 æ¡è®°å½•

3. **æ•°æ®æ¸…ç†**
   - å»ºè®®å®šæœŸæ¸…ç†è¶…è¿‡ä¸€å¹´çš„è´¦å•å½’æ¡£æ•°æ®
   - å¯ä½¿ç”¨äº‘å‡½æ•°å®šæœŸæ‰§è¡Œæ¸…ç†ä»»åŠ¡

## æ•°æ®å¯¼å‡º

ä½¿ç”¨ `exportData` äº‘å‡½æ•°å¯ä»¥å¯¼å‡ºæ‰€æœ‰ç”¨æˆ·æ•°æ®ï¼š

```javascript
wx.cloud.callFunction({
  name: 'exportData',
  success: res => {
    if (res.result.success) {
      const fileID = res.result.fileID
      // ä¸‹è½½æ–‡ä»¶
      wx.cloud.downloadFile({
        fileID: fileID,
        success: downloadRes => {
          console.log('å¯¼å‡ºæˆåŠŸ', downloadRes.tempFilePath)
        }
      })
    }
  }
})
```

## æ•°æ®ç»Ÿè®¡

ä½¿ç”¨ `getStats` äº‘å‡½æ•°å¯ä»¥è·å–ç»Ÿè®¡æ•°æ®ï¼š

```javascript
wx.cloud.callFunction({
  name: 'getStats',
  data: {
    year: 2024,
    month: 1,
    type: 'month'
  },
  success: res => {
    console.log('ç»Ÿè®¡æ•°æ®', res.result.data)
  }
})
```
